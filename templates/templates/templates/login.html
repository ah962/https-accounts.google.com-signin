{% extends "layout.html" %}

{% block title %}تسجيل الدخول{% endblock %}

{% block content %}
<div class="auth-container">
    <div class="auth-card">
        <div class="auth-header">
            <h2><i class="fas fa-sign-in-alt"></i> تسجيل الدخول</h2>
            <p>أدخل بياناتك للدخول إلى حسابك</p>
        </div>
        
        <form id="loginForm" class="auth-form">
            <div class="form-group">
                <label for="email">
                    <i class="fas fa-envelope"></i> البريد الإلكتروني
                </label>
                <input 
                    type="email" 
                    id="email" 
                    name="email" 
                    required
                    placeholder="example@domain.com"
                    autocomplete="email"
                >
                <div class="validation-feedback" id="emailFeedback"></div>
            </div>
            
            <div class="form-group">
                <label for="password">
                    <i class="fas fa-lock"></i> كلمة المرور
                </label>
                <div class="password-input">
                    <input 
                        type="password" 
                        id="password" 
                        name="password" 
                        required
                        placeholder="أدخل كلمة المرور"
                        autocomplete="current-password"
                    >
                    <button type="button" class="password-toggle" id="togglePassword">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <div class="validation-feedback" id="passwordFeedback"></div>
            </div>
            
            <div class="form-options">
                <label class="checkbox">
                    <input type="checkbox" id="remember" name="remember">
                    <span>تذكرني على هذا الجهاز</span>
                </label>
                
                <a href="#" class="forgot-password">نسيت كلمة المرور؟</a>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary btn-block" id="submitBtn">
                    <i class="fas fa-sign-in-alt"></i> تسجيل الدخول
                </button>
                
                <div class="auth-links">
                    <p>ليس لديك حساب؟ <a href="{{ url_for('register') }}">إنشاء حساب جديد</a></p>
                </div>
            </div>
        </form>
        
        <div class="auth-result" id="authResult"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const loginForm = document.getElementById('loginForm');
    const togglePassword = document.getElementById('togglePassword');
    const passwordInput = document.getElementById('password');
    const submitBtn = document.getElementById('submitBtn');
    const authResult = document.getElementById('authResult');
    
    // إظهار/إخفاء كلمة المرور
    togglePassword.addEventListener('click', function() {
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
    });
    
    // التحقق من صحة البريد أثناء الكتابة
    const emailInput = document.getElementById('email');
    const emailFeedback = document.getElementById('emailFeedback');
    
    emailInput.addEventListener('blur', function() {
        const email = this.value.trim();
        if (!email) {
            emailFeedback.textContent = 'البريد الإلكتروني مطلوب';
            emailFeedback.className = 'validation-feedback error';
            return;
        }
        
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            emailFeedback.textContent = 'صيغة البريد الإلكتروني غير صحيحة';
            emailFeedback.className = 'validation-feedback error';
        } else {
            emailFeedback.textContent = '';
            emailFeedback.className = 'validation-feedback';
        }
    });
    
    // إرسال النموذج
    loginForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const email = emailInput.value.trim();
        const password = passwordInput.value;
        const remember = document.getElementById('remember').checked;
        
        // التحقق الأساسي
        if (!email || !password) {
            showResult('الرجاء ملء جميع الحقول', 'error');
            return;
        }
        
        // تعطيل الزر أثناء المعالجة
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التحقق...';
        
        try {
            const response = await fetch('/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    email: email,
                    password: password,
                    remember: remember
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showResult(data.message, 'success');
                // الانتقال بعد تأخير قصير
                setTimeout(() => {
                    window.location.href = data.redirect;
                }, 1500);
            } else {
                showResult(data.message, 'error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> تسجيل الدخول';
            }
            
        } catch (error) {
            showResult('حدث خطأ في الاتصال بالخادم', 'error');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> تسجيل الدخول';
            console.error('Error:', error);
        }
    });
    
    function showResult(message, type) {
        authResult.textContent = message;
        authResult.className = `auth-result ${type}`;
        authResult.style.display = 'block';
        
        // إخفاء الرسالة بعد 5 ثواني
        setTimeout(() => {
            authResult.style.display = 'none';
        }, 5000);
    }
});
</script>
{% endblock %}
